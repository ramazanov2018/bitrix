"use strict";BX.namespace("Tasks.Component"),function(){void 0===BX.Tasks.Component.TasksWidgetMemberSelector&&(BX.Tasks.Component.TasksWidgetMemberSelector=BX.Tasks.Component.extend({sys:{code:"tdp-mem-sel",types:[]},methodsStatic:{instances:[],getInstance:function(e){return BX.Tasks.Component.TasksWidgetMemberSelector.instances[e]},addInstance:function(e,t){BX.Tasks.Component.TasksWidgetMemberSelector.instances[e]=t}},methods:{construct:function(){this.callConstruct(BX.Tasks.Component),BX.Tasks.Component.TasksWidgetMemberSelector.addInstance(this.id(),this),this.getSelector(),this.option("inputSpecial")&&this.getSelector().bindEvent("change",this.onChanged.bind(this));var e=this;"auditor"!==this.option("userType")&&"accomplice"!==this.option("userType")||BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:"+this.option("userType")+"Added",function(t){e.getSelector().onSelectorItemSelected(t.data)}),BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+this.option("userType")+"Selected",function(t){e.getSelector().onControlItemSelected(t.data)}),BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+this.option("userType")+"Deselected",function(t){e.getSelector().onSelectorItemDeselected(t.data)})},onChanged:function(e){var t="";e[0]&&(t=this.getSelector().get(e[0]).id()),this.control("sole-input").value=t},getSelector:function(){return this.subInstance("selector",function(){var e={scope:this.scope(),hidePreviousIfSingleAndRequired:!0,data:this.option("data"),max:this.option("max"),min:this.option("min"),nameTemplate:this.option("nameTemplate"),path:this.option("path"),preRendered:!0,popupOffsetTop:3,popupOffsetLeft:40,readOnly:this.option("readOnly"),parent:this,userType:this.option("userType"),userRight:this.option("userRight"),taskLimitExceeded:this.option("taskLimitExceeded"),networkEnabled:this.option("networkEnabled")},t=this.option("types");e.mode=t.USER?"user":"group",e.useAdd=!!t["USER.MAIL"]&&this.option("modulesAvailable").mail;var i=new this.constructor.ItemManager(e);return i.bindEvent("change",function(){this.fireEvent("change",[arguments[0]])}.bind(this)),i})},count:function(){return this.getSelector().count()},export:function(){return this.getSelector().exportItemData(!0)},replaceItem:function(e,t){this.getSelector().replaceItem(e,t)},value:function(){return this.getSelector().value()},replaceAll:function(e){var t=this.getSelector();t.unload({itemFx:!1,checkRestrictions:!1}),t.load(e)},readOnly:function(e){this.getSelector().readonly(e)}}}),BX.Tasks.Component.TasksWidgetMemberSelector.ItemManager=BX.Tasks.UserItemSet.extend({dialog:null,dialogCallback:!0,sys:{code:"tdp-mem-sel-is"},options:{controlBind:"class",itemFx:"horizontal",itemFxHoverDelete:!0,prefixId:!0,mode:"all",path:{},hidePreviousIfSingleAndRequired:!1},methods:{construct:function(){this.callConstruct(BX.Tasks.UserItemSet),this.initDialog()},getDialog:function(){if(this.dialog)return this.dialog;let e=this.getDialogParams();return this.dialog=new BX.UI.EntitySelector.Dialog(e),this.dialog},getDialogParams:function(){let e={},t=this.option("userRight"),i=t.role,s=t.users,o=[];if("WRITE"===i)e.enableSearch=!0,e.multiple=this.option("max")>1,e.context="TASKS_MEMBER_SELECTOR_EDIT_"+this.option("userType"),e.entities=this.getDialogEntities(),e.preselectedItems=this.getDialogSelectedItems();else if("READE"===i){Object.keys(s).length>1?(e.enableSearch=!0,e.context="TASKS_MEMBER_SELECTOR_EDIT_"+this.option("userType"),e.entities=this.getDialogEntities()):e.enableSearch=!1;let t=[];for(var n in s){let e={};s.hasOwnProperty(n)&&(e.id=s[n].id,e.avatar=s[n].avatar,e.title=s[n].title,e.entityId="user",e.tabs="users",t.push(e))}e.items=t,e.tabs=[{id:"users",title:"Подчиненные"}],e.showAvatars=!0,e.dropdownMode=!0,e.multiple=this.option("max")>1,e.preselectedItems=this.getDialogSelectedItems()}else e.enableSearch=!1;return e.events={"Item:onSelect":function(e){if(!1===this.dialogCallback)return;var t=e.getData().item,n=this.prepareUserData(t);let a=this.dialog;if("READE"!==i)BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+this.option("userType")+"Selected",n);else{for(var r in s)s.hasOwnProperty(r)&&o.push(s[r].id);this.contains(o,t.id)?BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+this.option("userType")+"Selected",n):a.handleItemDeselect(t)}}.bind(this),"Item:onDeselect":function(e){if(!1!==this.dialogCallback){var t=e.getData().item,i=this.prepareUserData(t);this.option("hidePreviousIfSingleAndRequired")&&1===this.vars.constraint.min&&1===this.count()?this.forceDeleteFirst():BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+this.option("userType")+"Deselected",i)}}.bind(this),onHide:function(e){this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min>0&&this.count()<1&&this.restoreKept()}.bind(this)},e},contains:function(e,t){return t=String(t),-1!=e.indexOf(t)},initDialog:function(){for(var e=this.scope().getElementsByClassName("js-id-tdp-mem-sel-is-control"),t=0;t<e.length;t++){e[t].addEventListener("click",function(e){var t=this.option("userType"),i=this.option("taskLimitExceeded");"accomplice"!==t&&"auditor"!==t||!i?(this.getDialog().setTargetNode(e),this.getDialog().show()):BX.UI.InfoHelper.show("limit_tasks_observers_participants")}.bind(this))}},getDialogSelectedItems:function(){for(var e=this.option("data"),t=[],i=null,s=0;s<e.length;s++)(i=this.prepareItemData(e[s]))&&t.push(i);return t},getDialogUndeselectedItems:function(){var e=this.option("data"),t=[];if(1===this.option("min")&&1===this.option("max")){for(var i=null,s=0;s<e.length;s++)(i=this.prepareItemData(e[s]))&&t.push(i);return t}},getDialogEntities:function(){var e=this.option("mode"),t=this.option("networkEnabled"),i=[];return"user"===e?i=[{id:"user",options:{emailUsers:!0,networkUsers:t,extranetUsers:!0,inviteGuestLink:!0,myEmailUsers:!0}},{id:"department"}]:"group"===e&&(i=[{id:"project"}]),i},prepareItemData:function(e){var t=0;return"string"==typeof e?t=e.replace(/[A-Za-z]/gi,""):"object"==typeof e&&(e.ID?t=e.ID:e.id&&(t=e.id)),t<=0?null:["group"===this.option("mode")?"project":"user",t]},prepareUserData:function(e){var t=e.getCustomData(),i=e.getEntityType(),s=this.option("mode");return{AVATAR:e.avatar,DESCRIPTION:"",ENTITY_TYPE:"group"===s?"SG":"U",ID:e.getId(),NAME:t.get("name"),LAST_NAME:t.get("lastName"),EMAIL:t.get("email"),nameFormatted:BX.Text.encode(e.getTitle()),NETWORK_ID:"",URL:e.getLink(),USER_TYPE:i,type:{crmemail:!1,extranet:"extranet"===i,email:"email"===i,network:"network"===i},VALUE:("group"===s?"SG":"U")+e.getId()}},onSearchBlurred:function(){var e=BX("invite-email-email-user-popup");null!==e&&"block"===e.style.display||this.callMethod(BX.Tasks.UserItemSet,"onSearchBlurred")&&this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min>0&&this.restoreKept()},onSelectorItemSelected:function(e){if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min>0){this.vars.changed=!0;var t=this.extractItemValue(e);this.hasItem(t)||(this.addItem(e),this.vars.toDelete=!1,this.checkCanAddItems()||(this.instances.selector.close(),this.onSearchBlurred())),this.resetInput()}else this.callMethod(BX.Tasks.UserItemSet,"onSelectorItemSelected",arguments)},onControlItemSelected:function(e){this.callMethod(BX.Tasks.UserItemSet,"onSelectorItemSelected",arguments)},openAddForm:function(){var e=this.option("userType"),t=this.option("taskLimitExceeded");"accomplice"!==e&&"auditor"!==e||!t?(this.option("hidePreviousIfSingleAndRequired")&&1==this.vars.constraint.min&&1==this.vars.constraint.max&&this.forceDeleteFirst(),this.callMethod(BX.Tasks.UserItemSet,"openAddForm")):BX.UI.InfoHelper.show("limit_tasks_observers_participants")},onItemDeleteByCross:function(e){return!!this.callMethod(BX.Tasks.UserItemSet,"onItemDeleteByCross",arguments)||(this.option("hidePreviousIfSingleAndRequired")&&1===this.vars.constraint.min&&1===this.count()&&(this.forceDeleteFirst(),this.getDialog().setTargetNode(this.scope()),this.getDialog().show()),!1)},forceDeleteFirst:function(){var e=this.getItemFirst();e&&(this.vars.toDelete=e.data(),this.deleteItem(e.value(),{checkRestrictions:!1}))},restoreKept:function(){this.vars.toDelete&&(this.addItem(this.vars.toDelete,{checkRestrictions:!1}),this.vars.toDelete=!1)},addItem:function(e,t){this.callMethod(BX.Tasks.UserItemSet,"addItem",arguments),this.selectDialogItem(e)},deleteItem:function(e,t){return!!this.callMethod(BX.Tasks.UserItemSet,"deleteItem",arguments)&&(this.unselectDialogItem(e),!0)},unselectDialogItem:function(e){if(this.getDialog()){if(this.dialogCallback=!1,"object"==typeof e&&(e=e.data()),e=this.prepareItemData(e)){var t=this.getDialog().getItem(e);t&&t.deselect()}this.dialogCallback=!0}},selectDialogItem:function(e){if(this.getDialog()){if(this.dialogCallback=!1,e=this.prepareItemData(e)){var t=this.getDialog().getItem(e);t&&t.select(!0)}this.dialogCallback=!0}}}}))}.call(this);